# CodeSwitch 工作流水 / Process Log

> 最后更新: 2026-01-16

---

## 团队交接日报 / Daily Handoff Report

### 日期: 2026-01-16

#### 今日完成功能 / Completed Today

**www.lurus.cn 主页服务部署**

1. **www 前端项目** (`www/`)
   - Vue 3 + Vite + Tailwind CSS 4
   - 营销主页组件 (Hero, Features, Pricing, Download)
   - SPA 路由支持

2. **Gateway 改造** (`gateway-service/`)
   - 添加 WWW 配置支持 (`internal/conf/conf.go`)
   - 静态文件服务 + SPA fallback (`cmd/gateway/main.go`)
   - 多阶段 Dockerfile (`Dockerfile.www`)

3. **K8s 部署**
   - www-gateway Deployment (lurus-system namespace)
   - Traefik IngressRoute for www.lurus.cn
   - TLS 证书自动签发 (Let's Encrypt)
   - ConfigMap 配置管理

4. **监控和可观测性**
   - Prometheus 指标采集 (Pod annotations)
   - Grafana Dashboard (www-gateway-lurus)
   - HTTP + LLM 业务指标

5. **GUI 集成验证**
   - Lurus API 服务完整实现 (`services/lurus/`)
   - 前端 API 接口定义 (`frontend/src/services/lurus.ts`)
   - Gateway 配置页面 (`frontend/src/components/Gateway/Index.vue`)

#### 文件变更汇总 / Files Changed

```
acest-switch/
├── www/                                [NEW PROJECT]
│   ├── package.json
│   ├── vite.config.ts
│   ├── tailwind.config.ts
│   ├── index.html
│   └── src/
│       ├── App.vue
│       ├── main.ts
│       ├── router/index.ts
│       ├── services/api.ts
│       ├── components/
│       │   ├── Layout/ (Navbar, Footer)
│       │   ├── Hero/HeroSection.vue
│       │   ├── Features/FeatureGrid.vue
│       │   ├── Pricing/PricingCards.vue
│       │   └── Download/DownloadSection.vue
│       └── pages/
│           ├── Home.vue
│           ├── Pricing.vue
│           ├── Download.vue
│           └── About.vue

lurus-switch/gateway-service/
├── internal/conf/conf.go              [UPDATED] - Added WWW struct
├── cmd/gateway/main.go                [UPDATED] - Static file serving
└── Dockerfile.www                     [NEW] - Multi-stage build

K8s Manifests (on server):
├── /tmp/www-gateway.yaml              [NEW] - Deployment
├── /tmp/www-config.yaml               [NEW] - ConfigMap
└── /tmp/www-lurus-ingress.yaml        [NEW] - IngressRoute

Monitoring:
├── prometheus-config (monitoring ns)  [UPDATED] - Added scrape jobs
└── Grafana Dashboard                  [NEW] - www-gateway-lurus
```

#### 部署状态 / Deployment Status

| 组件 | 状态 | 访问地址 |
|------|------|----------|
| www-gateway | Running | https://www.lurus.cn |
| TLS Certificate | Issued | Let's Encrypt |
| Prometheus | Scraping | http://localhost:30090 |
| Grafana Dashboard | Available | https://grafana.lurus.cn/d/www-gateway |

#### 测试结果 / Test Results

```bash
# Homepage
curl -s -o /dev/null -w "%{http_code}" https://www.lurus.cn/
# Result: 200

# Pricing page
curl -s -o /dev/null -w "%{http_code}" https://www.lurus.cn/pricing
# Result: 200

# Health check
curl https://www.lurus.cn/health
# Result: {"status":"healthy"}

# Metrics
curl -s 'http://localhost:30090/api/v1/query?query=gateway_requests_total' | jq '.data.result | length'
# Result: 1 (metrics being collected)
```

---

### 日期: 2026-01-07 (Night Session)

#### 今日完成功能 / Completed Today

**Phase 8: Lurus Portal Website** (门户网站)

为 Lurus 创建了一个现代化、科技感十足的门户网站，已部署到本地 IIS。

1. **技术栈**
   - Nuxt 3 (Vue 3 SSG 框架)
   - Tailwind CSS 4 (暗色主题)
   - @vueuse/motion (动画效果)
   - GSAP (高级动画)
   - @iconify/vue (图标库)

2. **网站结构** (`lurus-portal/`)
   ```
   pages/
   ├── index.vue              # 首页 (动画 Hero + 特性展示)
   ├── products/
   │   ├── index.vue          # 产品概览
   │   ├── codeswitch.vue     # CodeSwitch 产品页
   │   └── gateway.vue        # Gateway 产品页
   ├── pricing.vue            # 定价页
   ├── docs/
   │   ├── index.vue          # 文档首页
   │   └── quickstart.vue     # 快速入门
   └── login.vue              # 用户登录/注册

   components/
   ├── Layout/
   │   ├── Navbar.vue         # 响应式导航栏
   │   └── Footer.vue         # 页脚
   ├── Hero/
   │   └── HeroSection.vue    # 动画英雄区
   └── Features/
       ├── FeatureGrid.vue    # 特性网格
       └── CTASection.vue     # 行动召唤区

   layouts/
   ├── default.vue            # 默认布局
   └── docs.vue               # 文档布局 (带侧边栏)
   ```

3. **视觉设计**
   - 暗色主题 (bg: #0f172a)
   - 主色调: Indigo (#6366f1)
   - 强调色: Cyan (#22d3ee)
   - 玻璃拟态卡片效果
   - 渐变背景 orbs
   - 粒子动画系统
   - 滚动入场动画

4. **IIS 部署配置**
   - 域名: `ai.lurus.cn` (hosts 文件已配置)
   - 物理路径: `D:\tools\lurus-switch\lurus-portal\.output\public`
   - web.config: URL Rewrite 规则 (SPA 路由支持)

5. **测试验证**
   - ✅ 静态生成成功 (`npm run generate`)
   - ✅ IIS 站点创建成功
   - ✅ http://ai.lurus.cn/ 可正常访问
   - ✅ 所有页面路由正常

#### 文件变更汇总 / Files Changed (lurus-portal)

```
lurus-portal/                           [NEW PROJECT]
├── nuxt.config.ts                      # Nuxt 配置
├── tailwind.config.ts                  # Tailwind 暗色主题
├── package.json                        # 依赖配置
├── app.vue                             # 根组件
├── layouts/
│   ├── default.vue                     # 默认布局
│   └── docs.vue                        # 文档布局
├── pages/
│   ├── index.vue                       # 首页
│   ├── pricing.vue                     # 定价
│   ├── login.vue                       # 登录
│   ├── products/
│   │   ├── index.vue
│   │   ├── codeswitch.vue
│   │   └── gateway.vue
│   └── docs/
│       ├── index.vue
│       └── quickstart.vue
├── components/
│   ├── Layout/
│   │   ├── Navbar.vue
│   │   └── Footer.vue
│   ├── Hero/
│   │   └── HeroSection.vue
│   └── Features/
│       ├── FeatureGrid.vue
│       └── CTASection.vue
├── assets/css/
│   └── tailwind.css                    # 全局样式
└── public/
    └── web.config                      # IIS 配置

系统配置:
├── C:\Windows\System32\drivers\etc\hosts    [UPDATED]
│   └── 添加: 127.0.0.1  ai.lurus.cn
└── IIS 站点: lurus-portal (ID: 6)
```

---

### 日期: 2026-01-07 (Evening Session)

#### 今日完成功能 / Completed Today

**Phase 7: Billing Admin UI + Backend API** (前端 + Sync Service)

1. **前端 Billing 管理模块** (`frontend/src/`)
   - `services/billing.ts` - Billing API 服务 (订阅/钱包/支付/配置)
   - `stores/billing.ts` - Pinia 状态管理
   - `components/Admin/Billing/Subscriptions/Index.vue` - 订阅管理页
   - `components/Admin/Billing/Balances/Index.vue` - 余额管理页
   - `components/Admin/Billing/Payments/Index.vue` - 支付记录页
   - `components/Admin/Billing/Settings/Index.vue` - 计费配置页
   - `router/index.ts` - 添加 billing 路由
   - `components/Admin/Index.vue` - 侧边栏菜单扩展
   - `locales/zh.json` + `locales/en.json` - 中英文国际化

2. **后端 Billing API** (`sync-service/`)
   - `pkg/models/billing.go` - Billing 数据模型 (Subscription/Wallet/Payment/Config)
   - `internal/admin/billing.go` - BillingService 核心服务
   - `internal/admin/billing_clients.go` - 外部服务客户端 (Lago/Casdoor/Alipay/WeChat)
   - `internal/api/billing.go` - BillingHandlers API 处理器
   - `internal/api/router.go` - 注册 billing 路由
   - `cmd/main.go` - 初始化 BillingService
   - `configs/config.yaml` - 添加 billing 配置示例

3. **API 端点清单**
   | 端点 | 功能 |
   |------|------|
   | `GET /api/v1/billing/plans` | 获取可用计划 |
   | `GET/POST /api/v1/billing/subscriptions` | 订阅列表/创建 |
   | `POST /api/v1/billing/subscriptions/:id/cancel` | 取消订阅 |
   | `POST /api/v1/billing/subscriptions/:id/reactivate` | 重新激活 |
   | `GET/POST /api/v1/billing/wallets` | 钱包列表/创建 |
   | `POST /api/v1/billing/wallets/:id/top-up` | 钱包充值 |
   | `GET /api/v1/billing/wallets/:id/transactions` | 交易记录 |
   | `GET/POST /api/v1/billing/payments` | 支付列表/创建 |
   | `POST /api/v1/billing/payments/:id/refund` | 退款 |
   | `POST /api/v1/billing/payments/:id/confirm` | 手动确认 |
   | `GET/PUT /api/v1/billing/config` | 配置读取/更新 |
   | `GET /api/v1/billing/status` | 服务状态 |
   | `POST /api/v1/billing/test/*` | 连接测试 |
   | `GET /api/v1/billing/users/:id/*` | 用户快捷查询 |

4. **测试验证**
   - ✅ 前端编译通过 (`npm run build:dev`)
   - ✅ 后端编译通过 (`go build ./...`)
   - ✅ sync-service 启动成功，所有路由注册正确
   - ✅ Wails 应用启动成功，Billing UI 页面可正常访问

---

**Phase 4-6: 开源计费框架集成** (Casdoor + Lago + gopay) - Morning Session

1. **基础设施部署文件**
   - `deploy/docker/docker-compose.yml` - 完整 Docker 服务栈 (8+ services)
   - `deploy/docker/.env.example` - 环境变量模板
   - `deploy/docker/casdoor/app.conf` - Casdoor 服务配置
   - `deploy/postgres/init-databases.sql` - 多数据库初始化
   - `deploy/postgres/init-codeswitch.sql` - CodeSwitch 扩展表 (7 tables)
   - `deploy/scripts/start-stack.ps1` - Windows 启动脚本
   - `deploy/scripts/init-lago.sh` - Lago 计费配置初始化

2. **计费服务集成层** (`services/billing/`)
   - `casdoor_service.go` - Casdoor OAuth2/OIDC SDK 封装
   - `lago_service.go` - Lago 计费 API 封装 (客户/订阅/钱包/用量/发票)
   - `payment_service.go` - gopay 支付集成 (支付宝 + 微信)
   - `auth_middleware.go` - JWT 认证中间件 (带缓存)
   - `billing_middleware.go` - 计费检查中间件 (余额检查 + 用量上报)
   - `billing_manager.go` - 统一服务编排管理器

3. **配置文件**
   - `deploy/docker/billing-config.example.json` - 完整配置示例

#### 遗留问题 / Known Issues

1. **数据持久化**: `sync-service/internal/admin/billing.go` 当前使用内存存储
   - 生产环境需迁移到数据库 (PostgreSQL/SQLite)
   - 建议复用 `deploy/postgres/init-codeswitch.sql` 中的 billing 表

2. **前后端对接**: 前端调用 `syncServiceClient.fetch()` 需要认证
   - 需先实现 sync-service 登录流程获取 JWT
   - 或在 Wails 中直接绑定 Go 方法 (跳过 HTTP)

3. **支付回调**: `billing_clients.go` 中支付宝/微信客户端为 Demo 实现
   - 生产需对接真实 gopay SDK
   - 需实现 webhook 回调处理

4. **gopay 依赖**: `go.mod` 中需要添加:
   ```
   github.com/go-pay/gopay v1.5.x
   ```

#### 明日建议起始点 / Suggested Starting Points

**选项 A: 前后端完整对接 (推荐)**
- 在前端实现 sync-service 登录流程
- 或将 BillingService 绑定到 Wails Go 后端
- 测试完整 CRUD 流程

**选项 B: 数据持久化**
- 将 BillingService 改用 SQLite/PostgreSQL
- 复用已设计的数据库 schema
- 添加数据迁移脚本

**选项 C: 支付集成**
- 接入真实 gopay SDK
- 实现支付回调 webhook
- 测试支付宝/微信支付流程

**选项 D: 部署验证**
- 启动 Docker Compose 完整栈
- 配置 Casdoor + Lago
- 端到端测试

#### 架构决策记录 / Architecture Decisions

| 决策 | 原因 |
|------|------|
| 选择 Casdoor 而非 Ory Kratos | Casdoor 自带 UI，部署更简单 |
| 选择 Lago 而非自建计费 | 开源、Y Combinator 投资、功能完整 |
| 使用 gopay 而非直接对接支付 API | 聚合 SDK，维护活跃，支持 v3 API |
| 异步批量上报用量 | 减少 Lago API 调用，提升性能 |
| Token 缓存 5 分钟 | 平衡安全性和性能 |

#### 文件变更汇总 / Files Changed

```
codeswitch/
├── frontend/src/
│   ├── services/
│   │   ├── billing.ts              [NEW] - Billing API service
│   │   └── sync.ts                 [UPDATED] - Made fetch() public
│   ├── stores/
│   │   └── billing.ts              [NEW] - Pinia store
│   ├── components/Admin/
│   │   ├── Index.vue               [UPDATED] - Sidebar menu
│   │   └── Billing/
│   │       ├── Subscriptions/Index.vue [NEW]
│   │       ├── Balances/Index.vue     [NEW]
│   │       ├── Payments/Index.vue     [NEW]
│   │       └── Settings/Index.vue     [NEW]
│   ├── router/index.ts             [UPDATED] - Billing routes
│   └── locales/
│       ├── zh.json                 [UPDATED] - Chinese i18n
│       └── en.json                 [UPDATED] - English i18n
├── sync-service/
│   ├── pkg/models/
│   │   └── billing.go              [NEW] - Billing models
│   ├── internal/admin/
│   │   ├── billing.go              [NEW] - BillingService
│   │   └── billing_clients.go      [NEW] - External clients
│   ├── internal/api/
│   │   ├── billing.go              [NEW] - BillingHandlers
│   │   └── router.go               [UPDATED] - Register routes
│   ├── cmd/main.go                 [UPDATED] - Init billing
│   └── configs/config.yaml         [UPDATED] - Billing config
├── deploy/
│   ├── docker/
│   │   ├── docker-compose.yml      [NEW]
│   │   ├── .env.example            [NEW]
│   │   ├── billing-config.example.json [NEW]
│   │   └── casdoor/app.conf        [NEW]
│   ├── postgres/
│   │   ├── init-databases.sql      [NEW]
│   │   └── init-codeswitch.sql     [NEW]
│   └── scripts/
│       ├── start-stack.ps1         [NEW]
│       └── init-lago.sh            [NEW]
├── services/billing/
│   ├── casdoor_service.go          [NEW]
│   ├── lago_service.go             [NEW]
│   ├── payment_service.go          [NEW]
│   ├── auth_middleware.go          [NEW]
│   ├── billing_middleware.go       [NEW]
│   └── billing_manager.go          [NEW]
└── doc/
    ├── CLAUDE-plan.md              [UPDATED - v4.1]
    └── process.md                  [UPDATED - this file]
```

---

## 历史记录 / History

*(归档时将旧记录移至 `doc/archive/process_vX.md`)*
