# CodeSwitch å¤šç«¯åŒæ­¥æ¶æ„è®¾è®¡

> ç‰ˆæœ¬: v4.1 | æ›´æ–°æ—¥æœŸ: 2026-01-07
>
> **æŠ€æœ¯é€‰å‹**: é‡‡ç”¨å¼€æºæ¡†æ¶ç»„åˆ (Casdoor + Lago + gopay)

## 0. å·²å®Œæˆé‡Œç¨‹ç¢‘

### Phase 1: ç»Ÿä¸€ LLM è°ƒç”¨ âœ…
- âœ… **NEW-API ç»Ÿä¸€ç½‘å…³**: æ‰€æœ‰ LLM è¯·æ±‚é€šè¿‡ NEW-API (localhost:3000) ç»Ÿä¸€è·¯ç”±
- âœ… **Gemini æ ¼å¼è½¬æ¢**: Gemini Native API â†” OpenAI æ ¼å¼è‡ªåŠ¨è½¬æ¢
- âœ… **å¤šç«¯ç‚¹æ”¯æŒ**:
  - `/v1/messages` â†’ Claude (Anthropic format)
  - `/responses` â†’ Codex (OpenAI Responses API)
  - `/v1/chat/completions` â†’ Generic OpenAI
  - `/v1beta/models/*` â†’ Gemini (Native format, auto-converted)

### Phase 2: åŸºç¡€é…é¢ä½“ç³» âœ…
- âœ… **é…é¢ç®¡ç† API**: `GetQuotaInfo()`, `CheckQuota()`, `GetQuotaInfoByUserID()`
- âœ… **é…é¢äº‹ä»¶å¹¿æ’­**: é€šè¿‡ NATS `user.{user_id}.quota` ä¸»é¢˜å‘å¸ƒé…é¢å˜æ›´
- âœ… **åŒæ­¥é›†æˆé’©å­**: `OnQuotaChange()` é…é¢å˜æ›´å›è°ƒ

### Phase 3: NATS æ¶ˆæ¯æ€»çº¿ âœ…
- âœ… **LLM è¯·æ±‚æ¶ˆè´¹è€…**: `StartLLMRequestConsumer()` è®¢é˜… `llm.request.*`
- âœ… **æ¶ˆæ¯å»é‡æœºåˆ¶**: `publishedTraceCache` é˜²æ­¢é‡å¤å‘å¸ƒ
- âœ… **è®¢é˜…æ³„æ¼ä¿®å¤**: è¦†ç›–å‰å…ˆ Unsubscribe æ—§è®¢é˜…

### Phase 4: åŸºç¡€è®¾æ–½éƒ¨ç½² âœ…
- âœ… **Docker Compose ç¼–æ’**: Casdoor + Lago + PostgreSQL + Redis + NATS å®Œæ•´æ ˆ
- âœ… **Casdoor é…ç½®**: OAuth2/OIDC è®¤è¯ã€ç¤¾äº¤ç™»å½•æ”¯æŒ
- âœ… **Lago åˆå§‹åŒ–**: è®¢é˜…è®¡åˆ’ã€è®¡è´¹æŒ‡æ ‡ã€ä¼˜æƒ åˆ¸è‡ªåŠ¨é…ç½®
- âœ… **PostgreSQL æ‰©å±•**: cs_* è¡¨ (ç”¨æˆ·æ‰©å±•ã€ç­¾åˆ°ã€é‚€è¯·ã€è®¾å¤‡)

### Phase 5-6: è®¡è´¹é›†æˆå±‚ âœ…
- âœ… **Casdoor SDK**: `casdoor_service.go` OAuth2 è®¤è¯æµç¨‹
- âœ… **Lago SDK**: `lago_service.go` è®¢é˜…/é’±åŒ…/ç”¨é‡ API
- âœ… **gopay æ”¯ä»˜**: `payment_service.go` æ”¯ä»˜å®/å¾®ä¿¡æ”¯ä»˜
- âœ… **è®¤è¯ä¸­é—´ä»¶**: `auth_middleware.go` JWT éªŒè¯ + ç¼“å­˜
- âœ… **è®¡è´¹ä¸­é—´ä»¶**: `billing_middleware.go` ä½™é¢æ£€æŸ¥ + ç”¨é‡ä¸ŠæŠ¥
- âœ… **ç»Ÿä¸€ç®¡ç†å™¨**: `billing_manager.go` æœåŠ¡ç¼–æ’

---

## 1. å¼€æºæ¡†æ¶é€‰å‹

### 1.1 æŠ€æœ¯æ ˆå¯¹æ¯”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           å¼€æºæ¡†æ¶é€‰å‹ (æ–¹æ¡ˆ A)                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     åŠŸèƒ½     â”‚   æ¡†æ¶   â”‚                        è¯´æ˜                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   èº«ä»½è®¤è¯   â”‚ Casdoor  â”‚ 10k+ â­ | UI-first IAM/SSO | OAuth2/OIDC/SAML          â”‚
â”‚              â”‚          â”‚ æ”¯æŒ 100+ IdP | è‡ªå¸¦ç®¡ç†åå° | Go + React               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   æƒé™ç®¡ç†   â”‚ Casbin   â”‚ 16.7k â­ | ACL/RBAC/ABAC | å†…ç½®äº Casdoor              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   è®¡è´¹ç³»ç»Ÿ   â”‚  Lago    â”‚ 7k+ â­ | ç”¨é‡è®¡è´¹ API | è®¢é˜…ç®¡ç† | é’±åŒ…/ç§¯åˆ†            â”‚
â”‚              â”‚          â”‚ Y Combinator æŠ•èµ„ | Go 87.9% | æä¾› Go SDK            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   æ”¯ä»˜ç½‘å…³   â”‚  gopay   â”‚ 4k+ â­ | æ”¯ä»˜å®/å¾®ä¿¡/PayPal | æç®€èšåˆ SDK            â”‚
â”‚              â”‚          â”‚ çº¯ Go | æ´»è·ƒç»´æŠ¤ | v3 API æ”¯æŒ                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ¡†æ¶èŒè´£åˆ’åˆ†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              å„æ¡†æ¶èŒè´£                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚   Casdoor (èº«ä»½è®¤è¯)                    Lago (è®¡è´¹ç³»ç»Ÿ)                          â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                         â”‚
â”‚   â€¢ ç”¨æˆ·æ³¨å†Œ/ç™»å½•                       â€¢ è®¢é˜…è®¡åˆ’ç®¡ç†                           â”‚
â”‚   â€¢ OAuth2/OIDC è®¤è¯                    â€¢ ç”¨é‡äº‹ä»¶è®¡é‡                           â”‚
â”‚   â€¢ ç¤¾äº¤ç™»å½• (GitHub/WeChat)            â€¢ é’±åŒ…/ç§¯åˆ†ç®¡ç†                          â”‚
â”‚   â€¢ MFA å¤šå› ç´ è®¤è¯                      â€¢ å‘ç¥¨ç”Ÿæˆ                               â”‚
â”‚   â€¢ ä¼šè¯ç®¡ç†                            â€¢ ä¼˜æƒ åˆ¸/æŠ˜æ‰£                            â”‚
â”‚   â€¢ API Key ç®¡ç†                        â€¢ è®¡è´¹ Webhook                          â”‚
â”‚                                                                                 â”‚
â”‚   gopay (æ”¯ä»˜ç½‘å…³)                      CodeSwitch (ä¸šåŠ¡é›†æˆ)                    â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                    â”‚
â”‚   â€¢ æ”¯ä»˜å®æ”¯ä»˜                          â€¢ NEW-API è´¦æˆ·åŒæ­¥                       â”‚
â”‚   â€¢ å¾®ä¿¡æ”¯ä»˜                            â€¢ LLM è¯·æ±‚æ‹¦æˆªè®¡è´¹                       â”‚
â”‚   â€¢ PayPal æ”¯ä»˜                         â€¢ å¤šç«¯ä¼šè¯åŒæ­¥ (NATS)                    â”‚
â”‚   â€¢ æ”¯ä»˜å›è°ƒå¤„ç†                        â€¢ ç­¾åˆ°/é‚€è¯·å¥–åŠ±                          â”‚
â”‚   â€¢ é€€æ¬¾å¤„ç†                            â€¢ è¿ç»´ç›‘æ§å‘Šè­¦                           â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 æ•°æ®æµå‘

```
ç”¨æˆ·è¯·æ±‚ â†’ Casdoor (è®¤è¯) â†’ CodeSwitch Gateway â†’ Lago (è®¡è´¹æ£€æŸ¥)
                                    â†“
                              NEW-API (LLM)
                                    â†“
                              Lago (ç”¨é‡ä¸ŠæŠ¥) â†’ gopay (å……å€¼)
```

---

## 2. é¡¹ç›®æ„¿æ™¯

å°† CodeSwitch å‡çº§ä¸º**å¤šç«¯ååŒçš„ AI ç½‘å…³å¹³å° + ç»Ÿä¸€è®¡è´¹ä¸­å¿ƒ**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           CodeSwitch å¹³å°æ„¿æ™¯                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   ğŸ” ä¸€æ¬¡æ³¨å†Œï¼Œåˆ°å¤„ä½¿ç”¨                                                       â”‚
â”‚   â”œâ”€â”€ æ‰‹æœºç«¯ App (Flutter)                                                  â”‚
â”‚   â”œâ”€â”€ æ¡Œé¢ç«¯ GUI (Wails 3)                                                  â”‚
â”‚   â”œâ”€â”€ å‘½ä»¤è¡Œå·¥å…· (claude-code, codex, gemini-cli)                           â”‚
â”‚   â””â”€â”€ Web ç®¡ç†åå°                                                          â”‚
â”‚                                                                             â”‚
â”‚   ğŸ’° çµæ´»çš„è®¡è´¹ä½“ç³»                                                          â”‚
â”‚   â”œâ”€â”€ VIP è®¢é˜… (åŒ…æœˆ/åŒ…å¹´) - æ›´å¤šæƒç›Š + æ¯æœˆç§¯åˆ†èµ é€                          â”‚
â”‚   â”œâ”€â”€ ç§¯åˆ†å……å€¼ - æŒ‰é‡ä»˜è´¹ï¼Œçµæ´»æ¶ˆè€—                                          â”‚
â”‚   â””â”€â”€ ç­¾åˆ°/é‚€è¯· - å…è´¹è·å–ç§¯åˆ†                                               â”‚
â”‚                                                                             â”‚
â”‚   ğŸ”„ å®æ—¶åŒæ­¥                                                                â”‚
â”‚   â”œâ”€â”€ ä¼šè¯å†å²äº‘ç«¯æ¼«æ¸¸                                                       â”‚
â”‚   â”œâ”€â”€ å¤šç«¯æ¶ˆæ¯å®æ—¶åŒæ­¥                                                       â”‚
â”‚   â””â”€â”€ é…é¢ä½™é¢å³æ—¶æ›´æ–°                                                       â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. ç³»ç»Ÿæ¶æ„ (v4.1)

### 3.1 æ•´ä½“æ¶æ„å›¾ (å¼€æºæ¡†æ¶ç‰ˆ)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                å®¢æˆ·ç«¯å±‚ (Clients)                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   æ‰‹æœºç«¯ App    â”‚   æ¡Œé¢ç«¯ GUI    â”‚   CLI å®¢æˆ·ç«¯    â”‚      Web ç®¡ç†åå°          â”‚
â”‚   (Flutter)     â”‚   (Wails 3)     â”‚  claude-code    â”‚      (Vue 3)              â”‚
â”‚                 â”‚   CodeSwitch    â”‚  codex          â”‚                           â”‚
â”‚                 â”‚                 â”‚  gemini-cli     â”‚                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                 â”‚                 â”‚                    â”‚
         â”‚     WebSocket   â”‚   HTTP/NATS     â”‚    HTTP/NATS       â”‚  HTTP/WS
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚         NATS Server           â”‚
                    â”‚    (æ¶ˆæ¯æ€»çº¿ + JetStream)      â”‚
                    â”‚    ç«¯å£: 4222 / 8222 (WS)     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                         â”‚                         â”‚
          â–¼                         â–¼                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Casdoor       â”‚    â”‚ CodeSwitch Gateway  â”‚    â”‚    Lago Billing     â”‚
â”‚   (èº«ä»½è®¤è¯)       â”‚    â”‚     (:18100)        â”‚    â”‚    (è®¡è´¹ç³»ç»Ÿ)        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ OAuth2/OIDC     â”‚    â”‚ â€¢ è®¤è¯ä¸­é—´ä»¶         â”‚    â”‚ â€¢ è®¢é˜…ç®¡ç†           â”‚
â”‚ â€¢ ç¤¾äº¤ç™»å½•         â”‚    â”‚ â€¢ è®¡è´¹ä¸­é—´ä»¶         â”‚    â”‚ â€¢ ç”¨é‡è®¡é‡           â”‚
â”‚ â€¢ MFA è®¤è¯        â”‚    â”‚ â€¢ LLM è¯·æ±‚è½¬å‘       â”‚    â”‚ â€¢ é’±åŒ…/ç§¯åˆ†          â”‚
â”‚ â€¢ ç”¨æˆ·ç®¡ç† UI     â”‚    â”‚ â€¢ æµå¼å“åº”           â”‚    â”‚ â€¢ å‘ç¥¨ç”Ÿæˆ           â”‚
â”‚ Port: 8000        â”‚    â”‚ â€¢ ç”¨é‡äº‹ä»¶ä¸ŠæŠ¥       â”‚    â”‚ Port: 3001           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                          â”‚                          â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                          â”‚                          â”‚
         â–¼                          â–¼                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     NEW-API     â”‚    â”‚     PostgreSQL      â”‚    â”‚       gopay         â”‚
â”‚   (LLM ç½‘å…³)     â”‚    â”‚     (æŒä¹…åŒ–)        â”‚    â”‚     (æ”¯ä»˜SDK)        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ ä¾›åº”å•†è·¯ç”±     â”‚    â”‚ â€¢ Casdoor ç”¨æˆ·è¡¨    â”‚    â”‚ â€¢ æ”¯ä»˜å® v3          â”‚
â”‚ â€¢ æ¨¡å‹ç®¡ç†       â”‚    â”‚ â€¢ Lago è®¡è´¹è¡¨       â”‚    â”‚ â€¢ å¾®ä¿¡æ”¯ä»˜ v3        â”‚
â”‚ â€¢ API Key       â”‚    â”‚ â€¢ ä¸šåŠ¡æ‰©å±•è¡¨        â”‚    â”‚ â€¢ PayPal             â”‚
â”‚ Port: 3000       â”‚    â”‚ Port: 5432          â”‚    â”‚ â€¢ å›è°ƒå¤„ç†           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 ä¸ NEW-API çš„å…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        CodeSwitch ä¸ NEW-API èŒè´£åˆ’åˆ†                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚   NEW-API (ç°æœ‰åŠŸèƒ½ï¼Œä¿æŒä¸å˜)              CodeSwitch (æ‰©å±•åŠŸèƒ½)                 â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€               â”‚
â”‚   â€¢ ç”¨æˆ·æ³¨å†Œ/ç™»å½•                          â€¢ VIP è®¢é˜…ç®¡ç†                        â”‚
â”‚   â€¢ API Key (Token) ç®¡ç†                   â€¢ ç§¯åˆ†è®¡è´¹ç³»ç»Ÿ                        â”‚
â”‚   â€¢ åŸºç¡€é…é¢ (æŒ‰é‡è®¡è´¹)                    â€¢ åŒ…æœˆ/åŒ…å¹´è®¢é˜…                        â”‚
â”‚   â€¢ LLM ä¾›åº”å•†ç®¡ç†                         â€¢ ç­¾åˆ°/é‚€è¯·å¥–åŠ±                        â”‚
â”‚   â€¢ æ¨¡å‹å®šä»·é…ç½®                           â€¢ å¤šç«¯ä¼šè¯åŒæ­¥                        â”‚
â”‚   â€¢ å……å€¼/å…‘æ¢ç                             â€¢ é«˜çº§æƒç›Šç®¡ç†                        â”‚
â”‚                                           â€¢ è¿ç»´ç›‘æ§å‘Šè­¦                        â”‚
â”‚                                                                                 â”‚
â”‚   æ•°æ®æµå‘:                                                                      â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                                      â”‚
â”‚   1. ç”¨æˆ·é€šè¿‡ CodeSwitch ç™»å½• â†’ éªŒè¯ NEW-API è´¦æˆ· â†’ è¿”å›æ‰©å±•çš„ç”¨æˆ·ä¿¡æ¯           â”‚
â”‚   2. LLM è¯·æ±‚ â†’ CodeSwitch æ£€æŸ¥ VIP/ç§¯åˆ† â†’ æ‰£å‡ç§¯åˆ† â†’ è½¬å‘åˆ° NEW-API            â”‚
â”‚   3. NEW-API é…é¢å˜æ›´ â†’ åŒæ­¥åˆ° CodeSwitch â†’ æ›´æ–°ç§¯åˆ†ä½™é¢                         â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. VIP è®¢é˜…ç³»ç»Ÿ (åŸºäº Lago)

### 4.1 è®¢é˜…è®¡åˆ’

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              VIP è®¢é˜…è®¡åˆ’å¯¹æ¯”                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     æƒç›Š     â”‚   å…è´¹ç‰ˆ     â”‚   æœˆåº¦ VIP    â”‚   å¹´åº¦ VIP   â”‚     ä¼ä¸šç‰ˆ          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   ä»·æ ¼       â”‚    Â¥0       â”‚   Â¥49/æœˆ     â”‚   Â¥399/å¹´    â”‚   æŒ‰éœ€å®šåˆ¶          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   æ¯æœˆç§¯åˆ†   â”‚    1000     â”‚   50000      â”‚   60000      â”‚   æ— é™              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   ç§¯åˆ†æŠ˜æ‰£   â”‚    æ—        â”‚   9æŠ˜        â”‚   8æŠ˜        â”‚   7æŠ˜               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   é€Ÿç‡é™åˆ¶   â”‚  10æ¬¡/åˆ†    â”‚  60æ¬¡/åˆ†     â”‚  120æ¬¡/åˆ†    â”‚   ä¸é™              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   æ¨¡å‹è®¿é—®   â”‚  åŸºç¡€æ¨¡å‹   â”‚  å…¨éƒ¨æ¨¡å‹    â”‚  å…¨éƒ¨æ¨¡å‹    â”‚   å…¨éƒ¨+ç§æœ‰éƒ¨ç½²      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   å†å²ä¿ç•™   â”‚   7å¤©       â”‚   90å¤©       â”‚   365å¤©      â”‚   æ°¸ä¹…              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   ä¼˜å…ˆé˜Ÿåˆ—   â”‚    âœ—       â”‚    âœ“        â”‚    âœ“âœ“       â”‚    âœ“âœ“âœ“             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   ä¸“å±å®¢æœ   â”‚    âœ—       â”‚    âœ—        â”‚    âœ“        â”‚    âœ“               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   API é¢åº¦   â”‚   å…±äº«      â”‚   ç‹¬ç«‹       â”‚   ç‹¬ç«‹       â”‚   ç‹¬ç«‹é›†ç¾¤          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 Lago è®¢é˜…é…ç½®

Lago ç®¡ç†è®¢é˜…è®¡åˆ’ï¼ŒCodeSwitch é€šè¿‡ API è°ƒç”¨ã€‚

```yaml
# Lago Plan é…ç½®ç¤ºä¾‹ (é€šè¿‡ Lago API åˆ›å»º)
plans:
  - code: "free"
    name: "å…è´¹ç‰ˆ"
    interval: "monthly"
    amount_cents: 0
    amount_currency: "CNY"
    charges:
      - billable_metric_code: "llm_tokens"
        charge_model: "standard"
        properties:
          amount: "0.001"  # æ¯ token 0.001 ç§¯åˆ†

  - code: "monthly_vip"
    name: "æœˆåº¦ VIP"
    interval: "monthly"
    amount_cents: 4900  # Â¥49
    amount_currency: "CNY"
    charges:
      - billable_metric_code: "llm_tokens"
        charge_model: "graduated"
        properties:
          graduated_ranges:
            - from_value: 0
              to_value: 50000
              per_unit_amount: "0"
            - from_value: 50001
              per_unit_amount: "0.0009"  # 9 æŠ˜

  - code: "yearly_vip"
    name: "å¹´åº¦ VIP"
    interval: "yearly"
    amount_cents: 39900  # Â¥399
    amount_currency: "CNY"
```

### 4.3 CodeSwitch æ‰©å±•è¡¨ (ä»…å­˜å‚¨ Lago æœªè¦†ç›–çš„æ•°æ®)

```sql
-- CodeSwitch ç”¨æˆ·æ‰©å±•è¡¨ (å…³è” Casdoor ç”¨æˆ·)
CREATE TABLE cs_user_extensions (
    user_id VARCHAR(64) PRIMARY KEY,      -- Casdoor user ID
    lago_customer_id VARCHAR(64) UNIQUE,  -- Lago customer ID
    invite_code VARCHAR(16) UNIQUE,
    invited_by VARCHAR(64),
    vip_features JSONB DEFAULT '{}',      -- é¢å¤– VIP ç‰¹æ€§
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ç­¾åˆ°è®°å½• (Lago ä¸æ”¯æŒï¼Œéœ€è‡ªå»º)
CREATE TABLE cs_checkin_records (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id VARCHAR(64) NOT NULL,
    checkin_date DATE NOT NULL,
    streak_days INT NOT NULL DEFAULT 1,
    credits_earned BIGINT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(user_id, checkin_date)
);

-- é‚€è¯·å…³ç³» (Lago ä¸æ”¯æŒï¼Œéœ€è‡ªå»º)
CREATE TABLE cs_invite_relations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    inviter_id VARCHAR(64) NOT NULL,
    invitee_id VARCHAR(64) NOT NULL,
    status VARCHAR(16) NOT NULL,          -- 'pending', 'activated', 'rewarded'
    reward_credits BIGINT DEFAULT 0,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(invitee_id)
);
```

### 4.4 Lago Go SDK é›†æˆç¤ºä¾‹

```go
import lago "github.com/getlago/lago-go-client"

// LagoService Lago è®¡è´¹æœåŠ¡å°è£…
type LagoService struct {
    client *lago.Client
}

func NewLagoService(apiKey, apiURL string) *LagoService {
    client := lago.New().SetApiKey(apiKey).SetBaseURL(apiURL)
    return &LagoService{client: client}
}

// CreateCustomer åˆ›å»ºå®¢æˆ· (ç”¨æˆ·æ³¨å†Œæ—¶è°ƒç”¨)
func (s *LagoService) CreateCustomer(userID, email, name string) error {
    customerInput := &lago.CustomerInput{
        ExternalID: userID,
        Email:      email,
        Name:       name,
    }
    _, err := s.client.Customer().Create(customerInput)
    return err
}

// CreateSubscription åˆ›å»ºè®¢é˜…
func (s *LagoService) CreateSubscription(userID, planCode string) error {
    subInput := &lago.SubscriptionInput{
        ExternalCustomerID: userID,
        PlanCode:           planCode,
        ExternalID:         userID + "_" + planCode,
    }
    _, err := s.client.Subscription().Create(subInput)
    return err
}

// SendUsageEvent å‘é€ç”¨é‡äº‹ä»¶ (LLM è°ƒç”¨å)
func (s *LagoService) SendUsageEvent(userID, traceID string, tokens int) error {
    eventInput := &lago.EventInput{
        TransactionID:      traceID,
        ExternalCustomerID: userID,
        Code:               "llm_tokens",
        Properties: map[string]interface{}{
            "tokens": tokens,
        },
    }
    return s.client.Event().Create(eventInput)
}

// GetWalletBalance è·å–é’±åŒ…ä½™é¢
func (s *LagoService) GetWalletBalance(userID string) (int64, error) {
    wallets, err := s.client.Wallet().GetList(lago.WalletListInput{
        ExternalCustomerID: userID,
    })
    if err != nil || len(wallets.Wallets) == 0 {
        return 0, err
    }
    return wallets.Wallets[0].Balance, nil
}

// TopUpWallet é’±åŒ…å……å€¼ (gopay æ”¯ä»˜æˆåŠŸåè°ƒç”¨)
func (s *LagoService) TopUpWallet(walletID string, credits int64) error {
    input := &lago.WalletTransactionInput{
        WalletID:       walletID,
        PaidCredits:    fmt.Sprintf("%d", credits),
        GrantedCredits: "0",
    }
    _, err := s.client.WalletTransaction().Create(input)
    return err
}
```

---

## 5. ç§¯åˆ†/é’±åŒ…ç³»ç»Ÿ (åŸºäº Lago Wallet)

### 5.1 ç§¯åˆ†ä½“ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                               ç§¯åˆ†ä½“ç³»è®¾è®¡                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚   ç§¯åˆ†å•ä½: 1 ç§¯åˆ† = Â¥0.001 = $0.00014                                          â”‚
â”‚   æœ€å°å……å€¼: 1000 ç§¯åˆ† = Â¥1                                                       â”‚
â”‚                                                                                 â”‚
â”‚   ç§¯åˆ†æ¥æº                              ç§¯åˆ†æ¶ˆè€—                                 â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€                             â”€â”€â”€â”€â”€â”€â”€â”€â”€                                â”‚
â”‚   â€¢ å……å€¼è´­ä¹° (1:1)                      â€¢ LLM è°ƒç”¨ (æŒ‰æ¨¡å‹å®šä»·)                   â”‚
â”‚   â€¢ VIP æ¯æœˆèµ é€                        â€¢ é«˜çº§åŠŸèƒ½æ¶ˆè€—                            â”‚
â”‚   â€¢ ç­¾åˆ°å¥–åŠ± (æ¯æ—¥)                     â€¢ è¿‡æœŸå¤±æ•ˆ (å……å€¼ç§¯åˆ†ä¸è¿‡æœŸ)               â”‚
â”‚   â€¢ é‚€è¯·å¥–åŠ± (è¢«é‚€è¯·äººé¦–å……10%)                                                   â”‚
â”‚   â€¢ æ´»åŠ¨èµ é€                                                                    â”‚
â”‚                                                                                 â”‚
â”‚   ç§¯åˆ†ç±»å‹                                                                       â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                                      â”‚
â”‚   â€¢ å……å€¼ç§¯åˆ† (æ°¸ä¸è¿‡æœŸ)                                                          â”‚
â”‚   â€¢ èµ é€ç§¯åˆ† (æœ‰æ•ˆæœŸ30å¤©)                                                        â”‚
â”‚   â€¢ æ´»åŠ¨ç§¯åˆ† (æŒ‰æ´»åŠ¨è§„åˆ™)                                                        â”‚
â”‚                                                                                 â”‚
â”‚   æ¶ˆè´¹é¡ºåº: èµ é€ç§¯åˆ† â†’ æ´»åŠ¨ç§¯åˆ† â†’ å……å€¼ç§¯åˆ† (å…ˆè¿‡æœŸå…ˆæ¶ˆè´¹)                         â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 ç§¯åˆ†æ•°æ®æ¨¡å‹

```sql
-- ç”¨æˆ·ç§¯åˆ†è´¦æˆ·
CREATE TABLE user_credits (
    user_id UUID PRIMARY KEY REFERENCES users(id),
    balance BIGINT NOT NULL DEFAULT 0,           -- å½“å‰æ€»ä½™é¢
    total_recharged BIGINT NOT NULL DEFAULT 0,   -- ç´¯è®¡å……å€¼
    total_gifted BIGINT NOT NULL DEFAULT 0,      -- ç´¯è®¡èµ é€
    total_consumed BIGINT NOT NULL DEFAULT 0,    -- ç´¯è®¡æ¶ˆè´¹
    total_expired BIGINT NOT NULL DEFAULT 0,     -- ç´¯è®¡è¿‡æœŸ
    frozen BIGINT NOT NULL DEFAULT 0,            -- å†»ç»“é‡‘é¢ (é¢„æ‰£)
    version INT NOT NULL DEFAULT 0,              -- ä¹è§‚é”ç‰ˆæœ¬
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ç§¯åˆ†æ˜ç»† (åˆ†ç±»è´¦æˆ·)
CREATE TABLE credit_ledger (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id),
    credit_type VARCHAR(16) NOT NULL,            -- 'recharged', 'gifted', 'activity'
    source VARCHAR(32) NOT NULL,                 -- 'recharge', 'vip_monthly', 'checkin', 'invite', 'activity'
    amount BIGINT NOT NULL,                      -- åŸå§‹é‡‘é¢
    remaining BIGINT NOT NULL,                   -- å‰©ä½™é‡‘é¢
    expires_at TIMESTAMPTZ,                      -- è¿‡æœŸæ—¶é—´ (NULL=æ°¸ä¸è¿‡æœŸ)
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_ledger_user ON credit_ledger(user_id, created_at DESC);
CREATE INDEX idx_ledger_expires ON credit_ledger(expires_at) WHERE remaining > 0 AND expires_at IS NOT NULL;

-- ç§¯åˆ†æµæ°´
CREATE TABLE credit_transactions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id),
    type VARCHAR(16) NOT NULL,                   -- 'recharge', 'consume', 'gift', 'refund', 'expire', 'freeze', 'unfreeze'
    amount BIGINT NOT NULL,                      -- å˜åŠ¨é‡‘é¢ (æ­£=å¢åŠ , è´Ÿ=å‡å°‘)
    balance_before BIGINT NOT NULL,
    balance_after BIGINT NOT NULL,

    -- å…³è”ä¿¡æ¯
    order_id VARCHAR(64),                        -- å……å€¼è®¢å•å·
    trace_id VARCHAR(64),                        -- LLM è¯·æ±‚è¿½è¸ªID
    ledger_ids UUID[],                           -- æ¶ˆè´¹çš„åˆ†ç±»è´¦æˆ·IDåˆ—è¡¨

    -- å…ƒæ•°æ®
    description TEXT,
    metadata JSONB,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_transaction_user ON credit_transactions(user_id, created_at DESC);
CREATE INDEX idx_transaction_order ON credit_transactions(order_id) WHERE order_id IS NOT NULL;
CREATE INDEX idx_transaction_trace ON credit_transactions(trace_id) WHERE trace_id IS NOT NULL;

-- æ¨¡å‹å®šä»· (ç§¯åˆ†)
CREATE TABLE model_pricing (
    model VARCHAR(64) PRIMARY KEY,
    input_price DECIMAL(10,4) NOT NULL,          -- æ¯1K input tokens çš„ç§¯åˆ†
    output_price DECIMAL(10,4) NOT NULL,         -- æ¯1K output tokens çš„ç§¯åˆ†
    cache_create_price DECIMAL(10,4) DEFAULT 0,
    cache_read_price DECIMAL(10,4) DEFAULT 0,
    reasoning_price DECIMAL(10,4) DEFAULT 0,
    enabled BOOLEAN DEFAULT TRUE,
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- å……å€¼è®¢å•
CREATE TABLE recharge_orders (
    id VARCHAR(64) PRIMARY KEY,                  -- è®¢å•å·
    user_id UUID NOT NULL REFERENCES users(id),
    amount BIGINT NOT NULL,                      -- ç§¯åˆ†æ•°é‡
    price DECIMAL(10,2) NOT NULL,                -- æ”¯ä»˜é‡‘é¢ (åˆ†)
    payment_method VARCHAR(32) NOT NULL,         -- 'alipay', 'wechat', 'stripe'
    status VARCHAR(16) NOT NULL,                 -- 'pending', 'paid', 'failed', 'refunded'
    payment_id VARCHAR(128),                     -- ç¬¬ä¸‰æ–¹æ”¯ä»˜ID
    paid_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    expires_at TIMESTAMPTZ                       -- è®¢å•è¿‡æœŸæ—¶é—´
);

CREATE INDEX idx_order_user ON recharge_orders(user_id, created_at DESC);
CREATE INDEX idx_order_status ON recharge_orders(status, created_at DESC);

-- ç­¾åˆ°è®°å½•
CREATE TABLE checkin_records (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id),
    checkin_date DATE NOT NULL,
    streak_days INT NOT NULL DEFAULT 1,          -- è¿ç»­ç­¾åˆ°å¤©æ•°
    credits_earned BIGINT NOT NULL,              -- è·å¾—ç§¯åˆ†
    created_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(user_id, checkin_date)
);

-- é‚€è¯·å…³ç³»
CREATE TABLE invite_relations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    inviter_id UUID NOT NULL REFERENCES users(id),
    invitee_id UUID NOT NULL REFERENCES users(id),
    invite_code VARCHAR(16) NOT NULL,
    status VARCHAR(16) NOT NULL,                 -- 'pending', 'activated', 'rewarded'
    reward_credits BIGINT DEFAULT 0,             -- å·²è·å¾—å¥–åŠ±
    created_at TIMESTAMPTZ DEFAULT NOW(),
    activated_at TIMESTAMPTZ,
    UNIQUE(invitee_id)
);

CREATE INDEX idx_invite_inviter ON invite_relations(inviter_id);
```

### 4.3 ç§¯åˆ†æœåŠ¡ API

```go
// CreditService ç§¯åˆ†æœåŠ¡
type CreditService struct {
    db    *gorm.DB
    redis *redis.Client
    nats  *nats.Conn
}

// ç§¯åˆ†ç®¡ç†æ¥å£
type CreditAPI interface {
    // æŸ¥è¯¢
    GetBalance(userID string) (*CreditBalance, error)
    GetTransactions(userID string, filter TransactionFilter) ([]CreditTransaction, error)
    GetLedgerDetails(userID string) ([]CreditLedger, error)

    // å……å€¼
    CreateRechargeOrder(userID string, amount int64, method string) (*RechargeOrder, error)
    HandlePaymentCallback(orderID string, paymentResult PaymentResult) error

    // æ¶ˆè´¹
    PreDeduct(userID string, estimatedCost int64, traceID string) (string, error)  // è¿”å›é¢„æ‰£ID
    ConfirmDeduct(preDeductID string, actualCost int64) error
    CancelDeduct(preDeductID string) error

    // é€€æ¬¾
    Refund(userID string, traceID string, reason string) error

    // èµ é€
    GiftCredits(userID string, amount int64, source string, expiresAt *time.Time) error

    // ç­¾åˆ°
    Checkin(userID string) (*CheckinResult, error)
    GetCheckinStatus(userID string) (*CheckinStatus, error)

    // é‚€è¯·
    GenerateInviteCode(userID string) (string, error)
    AcceptInvite(inviteeID string, inviteCode string) error
    ProcessInviteReward(inviteeID string, rechargeAmount int64) error
}

// ç§¯åˆ†æ¶ˆè´¹æµç¨‹
func (s *CreditService) ConsumeCredits(
    ctx context.Context,
    userID string,
    cost int64,
    traceID string,
    model string,
) error {
    // 1. è·å–ç”¨æˆ·è®¢é˜…æŠ˜æ‰£
    discount := s.getSubscriptionDiscount(userID)
    actualCost := int64(float64(cost) * discount)

    // 2. è·å–å¯æ¶ˆè´¹çš„ç§¯åˆ†åˆ†ç±»è´¦æˆ· (æŒ‰è¿‡æœŸæ—¶é—´æ’åº)
    ledgers, err := s.getConsumableLedgers(userID, actualCost)
    if err != nil {
        return ErrInsufficientCredits
    }

    // 3. å¼€å¯äº‹åŠ¡æ‰£å‡
    tx := s.db.Begin()
    defer tx.Rollback()

    // 4. æŒ‰é¡ºåºæ‰£å‡å„åˆ†ç±»è´¦æˆ·
    var consumedLedgerIDs []uuid.UUID
    remaining := actualCost
    for _, ledger := range ledgers {
        if remaining <= 0 {
            break
        }
        deduct := min(remaining, ledger.Remaining)
        ledger.Remaining -= deduct
        remaining -= deduct
        consumedLedgerIDs = append(consumedLedgerIDs, ledger.ID)
        tx.Save(&ledger)
    }

    // 5. æ›´æ–°ç”¨æˆ·ä½™é¢
    s.updateBalance(tx, userID, -actualCost)

    // 6. è®°å½•æµæ°´
    s.recordTransaction(tx, userID, "consume", -actualCost, traceID, consumedLedgerIDs)

    // 7. æäº¤äº‹åŠ¡
    return tx.Commit().Error
}
```

### 4.4 ç­¾åˆ°å¥–åŠ±è§„åˆ™

```go
// ç­¾åˆ°å¥–åŠ±è®¡ç®—
func (s *CreditService) calculateCheckinReward(streakDays int, isVIP bool) int64 {
    baseReward := int64(100) // åŸºç¡€ 100 ç§¯åˆ†

    // è¿ç»­ç­¾åˆ°åŠ æˆ
    streakBonus := int64(0)
    switch {
    case streakDays >= 30:
        streakBonus = 200  // è¿ç»­30å¤©+
    case streakDays >= 14:
        streakBonus = 100  // è¿ç»­14å¤©+
    case streakDays >= 7:
        streakBonus = 50   // è¿ç»­7å¤©+
    case streakDays >= 3:
        streakBonus = 20   // è¿ç»­3å¤©+
    }

    total := baseReward + streakBonus

    // VIP åŒå€
    if isVIP {
        total *= 2
    }

    return total
}

// ç­¾åˆ°å¥–åŠ±è¡¨
/*
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   è¿ç»­å¤©æ•°   â”‚   æ™®é€šç”¨æˆ·   â”‚    VIP      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    1-2å¤©     â”‚    100      â”‚     200      â”‚
â”‚    3-6å¤©     â”‚    120      â”‚     240      â”‚
â”‚    7-13å¤©    â”‚    150      â”‚     300      â”‚
â”‚   14-29å¤©    â”‚    200      â”‚     400      â”‚
â”‚   30å¤©+      â”‚    300      â”‚     600      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
*/
```

---

## 5. ç»Ÿä¸€è´¦æˆ·ç³»ç»Ÿ

### 5.1 è´¦æˆ·å¯¹æ¥æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                             ç»Ÿä¸€ç™»å½•æµç¨‹                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚   æ–¹å¼1: NEW-API è´¦æˆ·ç™»å½•                                                        â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                       â”‚
â”‚                                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  1. è¾“å…¥è´¦å·å¯†ç    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  2. éªŒè¯    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚ Client  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚ CodeSwitch  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚   NEW-API   â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚        â–²                               â”‚                           â”‚           â”‚
â”‚        â”‚                               â”‚ 3. è¿”å›ç”¨æˆ·ä¿¡æ¯            â”‚           â”‚
â”‚        â”‚                               â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚        â”‚                               â”‚                                       â”‚
â”‚        â”‚                               â–¼ 4. æŸ¥è¯¢/åˆ›å»ºæ‰©å±•è´¦æˆ·                   â”‚
â”‚        â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚        â”‚                         â”‚ PostgreSQL  â”‚                               â”‚
â”‚        â”‚                         â”‚  (æ‰©å±•æ•°æ®)  â”‚                               â”‚
â”‚        â”‚                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚        â”‚                               â”‚                                       â”‚
â”‚        â”‚  5. è¿”å› JWT Token            â”‚                                       â”‚
â”‚        â”‚     + å®Œæ•´ç”¨æˆ·ä¿¡æ¯             â”‚                                       â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
â”‚                                                                                 â”‚
â”‚   æ–¹å¼2: ç¬¬ä¸‰æ–¹ç™»å½• (GitHub/WeChat/etc)                                          â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                         â”‚
â”‚   å¤ç”¨ NEW-API çš„ OAuth é›†æˆï¼Œç™»å½•æˆåŠŸååŒæ­¥åˆ° CodeSwitch                         â”‚
â”‚                                                                                 â”‚
â”‚   æ–¹å¼3: API Key è®¤è¯ (CLI åœºæ™¯)                                                 â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                             â”‚
â”‚   ä½¿ç”¨ NEW-API çš„ Token (sk-xxx)ï¼ŒCodeSwitch éªŒè¯åé™„åŠ  VIP/ç§¯åˆ†ä¿¡æ¯              â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 ç”¨æˆ·æ•°æ®æ¨¡å‹

```sql
-- CodeSwitch æ‰©å±•ç”¨æˆ·è¡¨ (ä¸ NEW-API ç”¨æˆ·å…³è”)
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    -- NEW-API å…³è”
    newapi_user_id INT NOT NULL UNIQUE,          -- NEW-API ç”¨æˆ·ID
    newapi_username VARCHAR(128) NOT NULL,

    -- åŸºç¡€ä¿¡æ¯
    display_name VARCHAR(128),
    email VARCHAR(256),
    avatar_url TEXT,

    -- é‚€è¯·ç 
    invite_code VARCHAR(16) UNIQUE,
    invited_by UUID REFERENCES users(id),

    -- çŠ¶æ€
    status VARCHAR(16) DEFAULT 'active',         -- 'active', 'suspended', 'deleted'
    role VARCHAR(16) DEFAULT 'user',             -- 'user', 'vip', 'admin'

    -- è®¾ç½®
    preferences JSONB DEFAULT '{}',

    -- æ—¶é—´æˆ³
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    last_login_at TIMESTAMPTZ,
    last_active_at TIMESTAMPTZ
);

CREATE INDEX idx_users_newapi ON users(newapi_user_id);
CREATE INDEX idx_users_invite_code ON users(invite_code);

-- ç”¨æˆ·è®¾å¤‡è¡¨
CREATE TABLE user_devices (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    device_id VARCHAR(128) NOT NULL,             -- è®¾å¤‡å”¯ä¸€æ ‡è¯†
    device_name VARCHAR(128),
    device_type VARCHAR(32) NOT NULL,            -- 'desktop', 'mobile', 'cli', 'web'
    client_name VARCHAR(64),                     -- 'codeswitch', 'claude-code', 'codex', 'gemini-cli'
    client_version VARCHAR(32),
    os_name VARCHAR(32),
    os_version VARCHAR(32),
    ip_address INET,
    last_active_at TIMESTAMPTZ DEFAULT NOW(),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(user_id, device_id)
);

CREATE INDEX idx_devices_user ON user_devices(user_id);

-- ç”¨æˆ· API Keys (CodeSwitch è‡ªæœ‰)
CREATE TABLE user_api_keys (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    key_hash VARCHAR(64) NOT NULL UNIQUE,        -- SHA256(key)
    name VARCHAR(128) NOT NULL,
    prefix VARCHAR(12) NOT NULL,                 -- 'cs_xxxx' ç”¨äºæ˜¾ç¤º

    -- æƒé™
    scopes TEXT[] DEFAULT '{}',                  -- 'llm:read', 'llm:write', 'session:read', etc
    rate_limit INT,

    -- æœ‰æ•ˆæœŸ
    expires_at TIMESTAMPTZ,
    last_used_at TIMESTAMPTZ,

    -- çŠ¶æ€
    status VARCHAR(16) DEFAULT 'active',
    revoked_at TIMESTAMPTZ,
    revoke_reason TEXT,

    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_api_keys_user ON user_api_keys(user_id);
CREATE INDEX idx_api_keys_prefix ON user_api_keys(prefix);
```

### 5.3 è®¤è¯æœåŠ¡ API

```go
// AuthService è®¤è¯æœåŠ¡
type AuthService struct {
    db         *gorm.DB
    redis      *redis.Client
    newAPIClient *NewAPIClient
    jwtSecret  []byte
}

// è®¤è¯æ¥å£
type AuthAPI interface {
    // ç™»å½•
    LoginWithPassword(username, password string) (*LoginResult, error)
    LoginWithOAuth(provider string, code string) (*LoginResult, error)
    LoginWithAPIKey(apiKey string) (*AuthContext, error)

    // ä¼šè¯
    ValidateToken(token string) (*AuthContext, error)
    RefreshToken(refreshToken string) (*LoginResult, error)
    Logout(token string) error
    LogoutAllDevices(userID string) error

    // API Key
    CreateAPIKey(userID string, name string, scopes []string, expiresAt *time.Time) (*APIKeyResult, error)
    ListAPIKeys(userID string) ([]APIKey, error)
    RevokeAPIKey(userID string, keyID string) error

    // è®¾å¤‡
    RegisterDevice(userID string, device DeviceInfo) error
    ListDevices(userID string) ([]UserDevice, error)
    RemoveDevice(userID string, deviceID string) error
}

// JWT Claims
type JWTClaims struct {
    jwt.RegisteredClaims
    UserID        string   `json:"uid"`
    NewAPIUserID  int      `json:"nuid"`
    Username      string   `json:"username"`
    Role          string   `json:"role"`
    SubscriptionPlan string `json:"plan"`
    CreditBalance int64    `json:"credits"`
    Scopes        []string `json:"scopes"`
}

// ç™»å½•ç»“æœ
type LoginResult struct {
    AccessToken  string        `json:"access_token"`
    RefreshToken string        `json:"refresh_token"`
    ExpiresIn    int           `json:"expires_in"`
    User         *UserInfo     `json:"user"`
    Subscription *Subscription `json:"subscription"`
    Credits      *CreditInfo   `json:"credits"`
}
```

---

## 6. ç³»ç»Ÿé›†æˆæµç¨‹

### 6.1 LLM è¯·æ±‚è®¡è´¹æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           LLM è¯·æ±‚è®¡è´¹æµç¨‹                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚ Client  â”‚     â”‚                    CodeSwitch Gateway                   â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚        â”‚                                    â”‚                                   â”‚
â”‚        â”‚ 1. LLM Request                     â”‚                                   â”‚
â”‚        â”‚    (with API Key)                  â”‚                                   â”‚
â”‚        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                                   â”‚
â”‚        â”‚                                    â”‚                                   â”‚
â”‚        â”‚                                    â”‚ 2. éªŒè¯ API Key                   â”‚
â”‚        â”‚                                    â”‚    è·å–ç”¨æˆ·ä¿¡æ¯                    â”‚
â”‚        â”‚                                    â–¼                                   â”‚
â”‚        â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚        â”‚                              â”‚  Redis   â”‚ (ç”¨æˆ·ç¼“å­˜)                   â”‚
â”‚        â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚        â”‚                                    â”‚                                   â”‚
â”‚        â”‚                                    â”‚ 3. æ£€æŸ¥ VIP çŠ¶æ€                  â”‚
â”‚        â”‚                                    â”‚    æ£€æŸ¥é€Ÿç‡é™åˆ¶                    â”‚
â”‚        â”‚                                    â”‚    ä¼°ç®—ç§¯åˆ†æ¶ˆè€—                    â”‚
â”‚        â”‚                                    â–¼                                   â”‚
â”‚        â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚        â”‚                              â”‚ ç§¯åˆ†é¢„æ‰£  â”‚                              â”‚
â”‚        â”‚                              â”‚ (å†»ç»“)   â”‚                              â”‚
â”‚        â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚        â”‚                                    â”‚                                   â”‚
â”‚        â”‚                                    â”‚ 4. è½¬å‘è¯·æ±‚åˆ° NEW-API              â”‚
â”‚        â”‚                                    â–¼                                   â”‚
â”‚        â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚        â”‚                              â”‚ NEW-API  â”‚                              â”‚
â”‚        â”‚                              â”‚ (LLM)    â”‚                              â”‚
â”‚        â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚        â”‚                                    â”‚                                   â”‚
â”‚        â”‚                                    â”‚ 5. æµå¼å“åº”                       â”‚
â”‚        â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                   â”‚
â”‚        â”‚                                    â”‚                                   â”‚
â”‚        â”‚                                    â”‚ 6. è®¡ç®—å®é™…æ¶ˆè€—                    â”‚
â”‚        â”‚                                    â”‚    ç¡®è®¤æ‰£å‡ç§¯åˆ†                    â”‚
â”‚        â”‚                                    â”‚    è®°å½•æ—¥å¿—                       â”‚
â”‚        â”‚                                    â–¼                                   â”‚
â”‚        â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚        â”‚                              â”‚PostgreSQLâ”‚                              â”‚
â”‚        â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 ç§¯åˆ†æ¶ˆè€—è®¡ç®—

```go
// è®¡ç®— LLM è¯·æ±‚ç§¯åˆ†æ¶ˆè€—
func (s *BillingService) CalculateCost(
    model string,
    inputTokens int,
    outputTokens int,
    cacheCreateTokens int,
    cacheReadTokens int,
    reasoningTokens int,
) (int64, error) {
    // è·å–æ¨¡å‹å®šä»·
    pricing, err := s.getModelPricing(model)
    if err != nil {
        return 0, err
    }

    // è®¡ç®—å„éƒ¨åˆ†æˆæœ¬ (å•ä½: ç§¯åˆ†)
    inputCost := float64(inputTokens) / 1000 * pricing.InputPrice
    outputCost := float64(outputTokens) / 1000 * pricing.OutputPrice
    cacheCreateCost := float64(cacheCreateTokens) / 1000 * pricing.CacheCreatePrice
    cacheReadCost := float64(cacheReadTokens) / 1000 * pricing.CacheReadPrice
    reasoningCost := float64(reasoningTokens) / 1000 * pricing.ReasoningPrice

    totalCost := inputCost + outputCost + cacheCreateCost + cacheReadCost + reasoningCost

    return int64(math.Ceil(totalCost)), nil
}

// æ¨¡å‹å®šä»·ç¤ºä¾‹ (ç§¯åˆ†/1K tokens)
/*
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          æ¨¡å‹              â”‚  Input    â”‚  Output   â”‚ Reasoning â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ claude-sonnet-4            â”‚    30     â”‚    150    â”‚    150    â”‚
â”‚ claude-opus-4              â”‚    150    â”‚    750    â”‚    750    â”‚
â”‚ claude-haiku               â”‚    8      â”‚    40     â”‚    -      â”‚
â”‚ gpt-4o                     â”‚    25     â”‚    100    â”‚    -      â”‚
â”‚ gpt-4o-mini                â”‚    2      â”‚    6      â”‚    -      â”‚
â”‚ gemini-2.0-flash           â”‚    1      â”‚    4      â”‚    -      â”‚
â”‚ gemini-1.5-pro             â”‚    12     â”‚    50     â”‚    -      â”‚
â”‚ deepseek-chat              â”‚    1      â”‚    2      â”‚    -      â”‚
â”‚ deepseek-reasoner          â”‚    5      â”‚    20     â”‚    20     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç¤ºä¾‹è®¡ç®—:
- ä½¿ç”¨ claude-sonnet-4 å‘é€ 2000 tokensï¼Œæ”¶åˆ° 500 tokens
- Input: 2000/1000 * 30 = 60 ç§¯åˆ†
- Output: 500/1000 * 150 = 75 ç§¯åˆ†
- æ€»è®¡: 135 ç§¯åˆ†
- VIP 8æŠ˜: 135 * 0.8 = 108 ç§¯åˆ†
*/
```

---

## 7. NATS æ¶ˆæ¯æ‰©å±•

### 7.1 æ–°å¢æ¶ˆæ¯ä¸»é¢˜

```
# è´¦æˆ·ç›¸å…³
user.{user_id}.subscription      # è®¢é˜…çŠ¶æ€å˜æ›´
user.{user_id}.credits           # ç§¯åˆ†å˜æ›´
user.{user_id}.checkin           # ç­¾åˆ°äº‹ä»¶
user.{user_id}.invite            # é‚€è¯·äº‹ä»¶

# è®¡è´¹ç›¸å…³
billing.consumption.{user_id}    # æ¶ˆè´¹è®°å½•
billing.recharge.{user_id}       # å……å€¼è®°å½•
billing.refund.{user_id}         # é€€æ¬¾è®°å½•

# ç®¡ç†ç›¸å…³
admin.subscription.{action}      # è®¢é˜…ç®¡ç†æ“ä½œ
admin.credits.{action}           # ç§¯åˆ†ç®¡ç†æ“ä½œ
```

### 7.2 æ¶ˆæ¯æ ¼å¼

```typescript
// è®¢é˜…å˜æ›´äº‹ä»¶
interface SubscriptionEvent {
    user_id: string;
    action: 'created' | 'renewed' | 'upgraded' | 'downgraded' | 'cancelled' | 'expired';
    plan_id: string;
    expires_at?: number;
    timestamp: number;
}

// ç§¯åˆ†å˜æ›´äº‹ä»¶
interface CreditEvent {
    user_id: string;
    type: 'recharge' | 'consume' | 'gift' | 'refund' | 'expire';
    amount: number;
    balance: number;
    source?: string;
    trace_id?: string;
    timestamp: number;
}

// ç­¾åˆ°äº‹ä»¶
interface CheckinEvent {
    user_id: string;
    streak_days: number;
    credits_earned: number;
    timestamp: number;
}
```

---

## 8. å‰ç«¯å¢å¼º

### 8.1 æ–°å¢é¡µé¢

```
/account                    # ã€æ–°å¢ã€‘è´¦æˆ·ä¸­å¿ƒ
â”œâ”€â”€ /account/subscription   # è®¢é˜…ç®¡ç†
â”œâ”€â”€ /account/credits        # ç§¯åˆ†ç®¡ç†
â”œâ”€â”€ /account/recharge       # å……å€¼ä¸­å¿ƒ
â”œâ”€â”€ /account/transactions   # äº¤æ˜“è®°å½•
â”œâ”€â”€ /account/checkin        # ç­¾åˆ°ä¸­å¿ƒ
â”œâ”€â”€ /account/invite         # é‚€è¯·å¥½å‹
â””â”€â”€ /account/devices        # è®¾å¤‡ç®¡ç†

/admin                      # ã€å¢å¼ºã€‘ç®¡ç†åå°
â”œâ”€â”€ /admin/users            # ç”¨æˆ·ç®¡ç† (å¢åŠ è®¢é˜…/ç§¯åˆ†æŸ¥çœ‹)
â”œâ”€â”€ /admin/subscriptions    # è®¢é˜…ç®¡ç†
â”œâ”€â”€ /admin/credits          # ç§¯åˆ†ç®¡ç†
â”œâ”€â”€ /admin/recharges        # å……å€¼è®¢å•
â”œâ”€â”€ /admin/pricing          # å®šä»·ç®¡ç†
â””â”€â”€ /admin/promotions       # æ´»åŠ¨ç®¡ç†
```

### 8.2 ç»„ä»¶è®¾è®¡

```
components/
â”œâ”€â”€ Account/
â”‚   â”œâ”€â”€ SubscriptionCard.vue      # å½“å‰è®¢é˜…çŠ¶æ€
â”‚   â”œâ”€â”€ CreditsBalance.vue        # ç§¯åˆ†ä½™é¢
â”‚   â”œâ”€â”€ RechargeModal.vue         # å……å€¼å¼¹çª—
â”‚   â”œâ”€â”€ PlanComparison.vue        # å¥—é¤å¯¹æ¯”
â”‚   â”œâ”€â”€ TransactionList.vue       # äº¤æ˜“è®°å½•
â”‚   â”œâ”€â”€ CheckinCalendar.vue       # ç­¾åˆ°æ—¥å†
â”‚   â”œâ”€â”€ InviteCard.vue            # é‚€è¯·å¡ç‰‡
â”‚   â””â”€â”€ DeviceList.vue            # è®¾å¤‡åˆ—è¡¨
â”‚
â”œâ”€â”€ Billing/
â”‚   â”œâ”€â”€ CostEstimator.vue         # è´¹ç”¨ä¼°ç®—
â”‚   â”œâ”€â”€ UsageChart.vue            # ä½¿ç”¨é‡å›¾è¡¨
â”‚   â”œâ”€â”€ ModelPricingTable.vue     # æ¨¡å‹å®šä»·è¡¨
â”‚   â””â”€â”€ BillingHistory.vue        # è´¦å•å†å²
```

---

## 10. å®æ–½è·¯çº¿å›¾ (å¼€æºæ¡†æ¶ç‰ˆ)

### Phase 4: åŸºç¡€è®¾æ–½éƒ¨ç½² âœ…

- [x] Docker Compose ç¼–æ’ (Casdoor + Lago + PostgreSQL + Redis)
  - `deploy/docker/docker-compose.yml` - å®Œæ•´æœåŠ¡æ ˆ
  - `deploy/docker/.env.example` - ç¯å¢ƒå˜é‡æ¨¡æ¿
- [x] Casdoor åˆå§‹åŒ–é…ç½®
  - `deploy/docker/casdoor/app.conf` - æœåŠ¡å™¨é…ç½®
  - æ”¯æŒ GitHub/WeChat ç¤¾äº¤ç™»å½•
- [x] Lago åˆå§‹åŒ–é…ç½®
  - `deploy/scripts/init-lago.sh` - è‡ªåŠ¨åŒ–åˆå§‹åŒ–è„šæœ¬
  - Billable Metrics: llm_tokens, api_requests
  - Plans: free/monthly_vip/yearly_vip
- [x] PostgreSQL æ‰©å±•è¡¨è¿ç§»
  - `deploy/postgres/init-databases.sql` - å¤šæ•°æ®åº“åˆå§‹åŒ–
  - `deploy/postgres/init-codeswitch.sql` - cs_* æ‰©å±•è¡¨

### Phase 5: CodeSwitch é›†æˆå±‚ âœ…

- [x] Casdoor SDK é›†æˆ
  - `services/billing/casdoor_service.go` - OAuth2 è®¤è¯æœåŠ¡
  - `services/billing/auth_middleware.go` - JWT è®¤è¯ä¸­é—´ä»¶
- [x] Lago SDK é›†æˆ
  - `services/billing/lago_service.go` - è®¡è´¹ API å°è£…
  - è®¢é˜…ç®¡ç†ã€ç”¨é‡ä¸ŠæŠ¥ã€é’±åŒ…ä½™é¢æŸ¥è¯¢
- [x] gopay æ”¯ä»˜é›†æˆ
  - `services/billing/payment_service.go` - æ”¯ä»˜å®/å¾®ä¿¡æ”¯ä»˜
  - æ”¯ä»˜å›è°ƒ â†’ Lago Wallet è‡ªåŠ¨å……å€¼
- [x] ç»Ÿä¸€ç®¡ç†å™¨
  - `services/billing/billing_manager.go` - æœåŠ¡ç¼–æ’
  - `services/billing/billing_middleware.go` - è®¡è´¹æ£€æŸ¥ä¸­é—´ä»¶
  - `deploy/docker/billing-config.example.json` - é…ç½®ç¤ºä¾‹

### Phase 6: Gateway è®¡è´¹ä¸­é—´ä»¶ âœ…

- [x] è¯·æ±‚æ‹¦æˆª â†’ Lago ä½™é¢æ£€æŸ¥ (BillingMiddleware.PreRequestHandler)
- [x] Token è®¡æ•° â†’ ä»å“åº”å¤´æˆ–ä¸Šä¸‹æ–‡è¯»å–
- [x] å“åº”å®Œæˆ â†’ Lago ç”¨é‡ä¸ŠæŠ¥ (BillingMiddleware.PostRequestHandler)
- [x] å¼‚æ­¥æ‰¹é‡ä¸ŠæŠ¥ â†’ å‡å°‘ API è°ƒç”¨ (processUsageQueue)

### Phase 7: è‡ªå»ºåŠŸèƒ½ (æš‚ç¼“)

> â¸ï¸ ç”¨æˆ·å†³å®šæš‚ä¸å®ç°ï¼Œåç»­æŒ‰éœ€å¼€å‘

- [ ] ç­¾åˆ°ç³»ç»Ÿ (cs_checkin_records)
- [ ] é‚€è¯·ç³»ç»Ÿ (cs_invite_relations)
- [ ] ç­¾åˆ°/é‚€è¯·å¥–åŠ± â†’ Lago Wallet èµ é€ç§¯åˆ†

### Phase 8: å‰ç«¯é¡µé¢

- [ ] ç™»å½•é¡µé¢ (è·³è½¬ Casdoor)
- [ ] è´¦æˆ·ä¸­å¿ƒ (è®¢é˜…/ç§¯åˆ†/å……å€¼)
- [ ] ç­¾åˆ°æ—¥å†
- [ ] é‚€è¯·å¡ç‰‡
- [ ] ç®¡ç†åå° (ä½¿ç”¨ Lago UI + Casdoor UI)
- [ ] æŠ¥è¡¨ç»Ÿè®¡

---

## 11. æŠ€æœ¯æ ˆæ±‡æ€»

| å±‚çº§ | æŠ€æœ¯é€‰å‹ | å¤‡æ³¨ |
|------|----------|------|
| æ¡Œé¢ç«¯ | Wails 3 + Vue 3 + Vite + Tailwind CSS | |
| ç§»åŠ¨ç«¯ | Flutter | |
| CLI | Node.js (gemini-cli) | |
| åç«¯æœåŠ¡ | Go + Gin + GORM | |
| æ¶ˆæ¯æ€»çº¿ | NATS + JetStream | |
| ä¸»æ•°æ®åº“ | PostgreSQL 16 | Casdoor + Lago å…±ç”¨ |
| ç¼“å­˜ | Redis 7 | |
| **èº«ä»½è®¤è¯** | **Casdoor** (10k+ â­) | å¼€æº IAM/SSO |
| **è®¡è´¹ç³»ç»Ÿ** | **Lago** (7k+ â­) | å¼€æºç”¨é‡è®¡è´¹ |
| **æ”¯ä»˜SDK** | **gopay** (4k+ â­) | æ”¯ä»˜å®/å¾®ä¿¡/PayPal |
| **æƒé™ç®¡ç†** | **Casbin** (16k+ â­) | å†…ç½®äº Casdoor |
| LLM ç½‘å…³ | NEW-API | ç°æœ‰ |

---

## 12. Docker Compose éƒ¨ç½²

```yaml
# docker-compose.yml
version: '3.8'

services:
  # PostgreSQL æ•°æ®åº“ (Casdoor + Lago + CodeSwitch å…±ç”¨)
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: codeswitch
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: codeswitch
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  # Redis ç¼“å­˜
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"

  # Casdoor èº«ä»½è®¤è¯
  casdoor:
    image: casbin/casdoor:latest
    depends_on:
      - postgres
    environment:
      RUNNING_IN_DOCKER: "true"
      driverName: postgres
      dataSourceName: "user=codeswitch password=${DB_PASSWORD} host=postgres port=5432 sslmode=disable dbname=casdoor"
    ports:
      - "8000:8000"

  # Lago è®¡è´¹ç³»ç»Ÿ
  lago-api:
    image: getlago/api:latest
    depends_on:
      - postgres
      - redis
    environment:
      DATABASE_URL: postgresql://codeswitch:${DB_PASSWORD}@postgres:5432/lago
      REDIS_URL: redis://redis:6379
      LAGO_API_URL: http://localhost:3001
      SECRET_KEY_BASE: ${LAGO_SECRET}
    ports:
      - "3001:3000"

  lago-front:
    image: getlago/front:latest
    depends_on:
      - lago-api
    environment:
      API_URL: http://lago-api:3000
      APP_ENV: production
    ports:
      - "8080:80"

  # NATS æ¶ˆæ¯æ€»çº¿
  nats:
    image: nats:2.10-alpine
    command: ["--jetstream", "--store_dir=/data"]
    volumes:
      - nats_data:/data
    ports:
      - "4222:4222"
      - "8222:8222"

  # CodeSwitch Gateway (ä¸»æœåŠ¡)
  codeswitch:
    build: ./codeswitch
    depends_on:
      - postgres
      - redis
      - casdoor
      - lago-api
      - nats
    environment:
      CASDOOR_ENDPOINT: http://casdoor:8000
      LAGO_API_URL: http://lago-api:3000
      LAGO_API_KEY: ${LAGO_API_KEY}
      NATS_URL: nats://nats:4222
      DATABASE_URL: postgresql://codeswitch:${DB_PASSWORD}@postgres:5432/codeswitch
    ports:
      - "18100:18100"

volumes:
  postgres_data:
  nats_data:
```

---

## 13. å‚è€ƒèµ„æº

### å¼€æºæ¡†æ¶
- [Casdoor - GitHub](https://github.com/casdoor/casdoor) | [æ–‡æ¡£](https://casdoor.org/docs/overview/)
- [Lago - GitHub](https://github.com/getlago/lago) | [API æ–‡æ¡£](https://doc.getlago.com/)
- [gopay - GitHub](https://github.com/go-pay/gopay)
- [Casbin - GitHub](https://github.com/casbin/casbin)

### åŸºç¡€è®¾æ–½
- [NATS Documentation](https://docs.nats.io/)
- [NEW-API æºç ](https://github.com/Calcium-Ion/new-api)

### æ”¯ä»˜å¹³å°
- [æ”¯ä»˜å®å¼€æ”¾å¹³å°](https://open.alipay.com/)
- [å¾®ä¿¡æ”¯ä»˜å¼€å‘æ–‡æ¡£](https://pay.weixin.qq.com/wiki/doc/api/index.html)
